#!/bin/sh

DRIVER=`basename $0`
CFLAGS="-pipe"
[ $HOMEBREW_VERBOSE ] && FLAGS="-v"
[ $HOMEBREW_UNIVERSAL ] && CFLAGS="-arch i386 -arch x86_64 $CFLAGS"

for x in $HOMEBREW_DEP_PREFIXES; do
  x="$HOMEBREW_PREFIX/opt/$x"
  [ -d "$x/lib" ] && LDFLAGS="-L$x/lib $LDFLAGS"
  [ -d "$x/include" ] && CPPFLAGS="-I$x/include $CPPFLAGS"
done

if [ $SDKROOT ]; then
  # setting --sysroot removes /usr/include /usr/local/include etc. from the
  # search paths. So we must add HOMEBREW_PREFIX/include even if /usr/local.
  CPPFLAGS="--sysroot=$SDKROOT -I$SDKROOT/usr/include/libxml2 -I$HOMEBREW_PREFIX/include $CPPFLAGS"
  LDFLAGS="-L$HOMEBREW_PREFIX/lib"
else
  if [ "$HOMEBREW_PREFIX" != "/usr/local" ]; then
    CPPFLAGS="-I$HOMEBREW_PREFIX/include $CPPFLAGS"
    LDFLAGS="-L$HOMEBREW_PREFIX/lib $LDFLAGS"
  fi
  CPPFLAGS="-I/usr/include/libxml2 $CPPFLAGS"
fi

case "$DRIVER" in
cc)
  [ $CC ] && DRIVER="$CC";;
c++)
  [ $CXX ] && DRIVER="$CXX";;
esac

case "$DRIVER" in
clang*|cc|c++)
  [ $HOMEBREW_OPTIMIZE ] && CFLAGS="-march=native -w -Os $CFLAGS"
  # We pass linker flags to cc because most build systems make no distinction
  # between when they call for a compiler or linker. Thus clang generates
  #Â spurious warnings. TODO don't do this: may hide essential information!
  FLAGS="$FLAGS -Qunused-arguments";;
ld)
  unset CPPFLAGS;;
cpp)
  unset LDFLAGS
  unset CFLAGS;;
esac

#TODO bottles interrupt here, changing optimisation, removing march and adding mtune
#TODO fix pkg-config files
#TODO make dirs for each major version of xcode, eg. 4.3, 4.4 (symlink to 4.3)
#TODO don't add libxml2 include path if we depend on the libxml2 formula
#TODO auto-caveat plists, stop caveats being printed multiple times for completion :P
#TODO add paths for XQuartz and X11 based on ENV.x11 and requirements like :freetype
#TODO remove -g, -O2, etc. We determine these flags
#TODO setting HOMEBREW_PREFIX is rather unnecessary
#TODO perhaps you can also detect SDKROOT so this script can be executed without a brew wrapper

exec xcrun $DRIVER \
           $FLAGS \
           $CFLAGS \
           $CPPFLAGS \
           $LDFLAGS \
           "$@"
